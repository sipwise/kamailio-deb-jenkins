# This jenkins-job-build configuration sets up Jenkins jobs
# for building Debian packages of kamailio, building
# 4.0 branch

- project:
    name: vseva-kamailio40-nightly
    repos: https://github.com/linuxmaniac/kamailio.git
    jobs:
      - '{name}-source'
      - '{name}-binaries'
      - '{name}-repos'
      - '{name}-piuparts'

- job-template:
      name: '{name}-source'
      project-type: matrix
      description: |
        Build Debian source package of {name}. This is a sandbox to play with the packaging stuff.
        <!-- Do NOT edit this job through the web, it is generated via jenkins-job-builder! -->
      logrotate:
        numToKeep: 5
      disabled: false
      auth-token: kamailio-upstream-secret
      scm:
        - git:
            url: '{repos}'
            name: origin
            refspec: +refs/heads/*:refs/remotes/origin/*
            basedir: source
            branches:
              - '4.0'
            wipe-workspace: false
      execution-strategy:
        sequential: true
      axes:
        - axis:
            type: user-defined
            name: distribution
            values:
             - wheezy
             - squeeze
             - lenny
             - lucid
             - precise
      builders:
        - shell: 'rm -f ./* || true'
        - shell: '/home/admin/kamailio-deb-jenkins/scripts/jdg-generate-source'
        - shell: |
            mkdir -p report
            /usr/bin/lintian-junit-report *.dsc > report/lintian.xml
      publishers:
        - archive:
            artifacts: '*.gz,*.bz2,*.xz,*.deb,*.dsc,*.changes,lintian.txt'
        - trigger:
            project: '{name}-binaries'
            threshold: UNSTABLE
        - junit:
            results: '**/lintian.xml'
            keep-long-stdio: false
        - fingerprint:
            record-artifacts: true
      wrappers:
        - timestamps

- job-template:
      name: '{name}-binaries'
      project-type: matrix
      description: |
        Build Debian/Ubuntu binary packages of {name}. This is a sandbox to play with the packaging stuff.
        <!-- Do NOT edit this job through the web, it is generated via jenkins-job-builder! -->
      logrotate:
        numToKeep: 5
      execution-strategy:
        sequential: true
      axes:
        - axis:
            type: user-defined
            name: architecture
            values:
             - i386
             - amd64
        - axis:
            type: user-defined
            name: distribution
            values:
             - wheezy
             - squeeze
             - lenny
             - lucid
             - precise
      builders:
        - shell: |
           echo "* Removing files workspace before copying artifacts from another project. * "
           rm -f ./* || true
        - copyartifact:
            project: '{name}-source/distribution=$distribution'
            filter: '*'
            which-build: upstream-build
            fallback-to-last-successful: true
        - shell: "/home/admin/kamailio-deb-jenkins/scripts/jdg-build-package"
        - shell: |
            mkdir -p report
            /usr/bin/lintian-junit-report *.changes > report/lintian.xml
        - shell: |
            mkdir -p report adt
            touch adt/summary # do not fail if no autopkgtest run took place
            /usr/bin/adtsummary_tap adt/summary > report/autopkgtest.tap
      publishers:
        - archive:
            artifacts: '**/*.gz,**/*.bz2,**/*.xz,**/*.deb,**/*.dsc,**/*.changes,**/lintian.txt'
        - tap:
            results: 'report/*.tap'
        - junit:
            results: '**/lintian.xml'
            keep-long-stdio: false
        - fingerprint:
            record-artifacts: true
        - trigger:
            project: '{name}-repos'
            threshold: UNSTABLE
        - trigger:
            project: '{name}-piuparts'
            threshold: UNSTABLE
        - workspace-cleanup:
            dirmatch: false
      wrappers:
        - timestamps

- job-template:
      name: '{name}-repos'
      project-type: matrix
      description: |
        Repository handling for Debian packages of {name}. This is a sandbox to play with the packaging stuff.
        <!-- Do NOT edit this job through the web, it is generated via jenkins-job-builder! -->
      logrotate:
        numToKeep: 5
      execution-strategy:
        sequential: true
      axes:
        - axis:
            type: user-defined
            name: architecture
            values:
             - i386
             - amd64
        - axis:
            type: user-defined
            name: distribution
            values:
             - wheezy
             - squeeze
             - lenny
             - lucid
             - precise
      builders:
        - shell: |
           echo "* Removing files workspace before copying artifacts from another project. * "
           rm -f ./* || true
        - copyartifact:
            project: '{name}-binaries/architecture=$architecture,distribution=$distribution'
            filter: '*'
            target: 'binaries/'
            which-build: upstream-build
            fallback-to-last-successful: true
        - shell: "/home/admin/kamailio-deb-jenkins/scripts/jdg-repository"
      publishers:
        - archive:
            artifacts: '**/*.gz,**/*.bz2,**/*.xz,**/*.deb,**/*.dsc,**/*.changes'
        - fingerprint:
            record-artifacts: true
        - workspace-cleanup:
            dirmatch: false
      wrappers:
        - timestamps

- job-template:
      name: '{name}-piuparts'
      project-type: matrix
      description: |
        Installation and upgrade tests for {name} Debian packages. This is a sandbox to play with the packaging stuff.
        <!-- Do NOT edit this job through the web, it is generated via jenkins-job-builder! -->
      disabled: false
      logrotate:
        numToKeep: 5
      execution-strategy:
        sequential: true
      axes:
        - axis:
            type: user-defined
            name: architecture
            values:
             - i386
             - amd64
        - axis:
            type: user-defined
            name: distribution
            values:
             - wheezy
             - squeeze
             - lenny
             - lucid
             - precise
      builders:
        - shell: |
           echo "* Removing files workspace before copying artifacts from another project. * "
           rm -f ./* || true
        - copyartifact:
            project: '{name}-binaries/architecture=$architecture,distribution=$distribution'
            filter: '*.deb'
            which-build: upstream-build
            fallback-to-last-successful: true
            flatten: true
            target: 'artifacts/'
        - shell: "/home/admin/kamailio-deb-jenkins/scripts/jdg-piuparts"
      publishers:
        - tap:
            results: 'piuparts.tap'
        - archive:
            artifacts: 'piuparts.*'
        - fingerprint:
            record-artifacts: true
        - workspace-cleanup:
            dirmatch: false
      wrappers:
        - timestamps
